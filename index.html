<!doctype html>

<html lang="en">

<head>
	<meta charset="utf-8">
	<link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">
	<title>SPACE INVADERS</title>
	<button style="position:absolute; top:700px; left:25px;" id="play" onClick="newGame()">newGame</button>
  <link href="style.css" rel="stylesheet"/>
</head>

<body>
	<h1>SPACEINVADER</h1>
	<button style="position:absolute; top:700px; left:25px;" id="play" onClick="newGame()">newGame</button>
	<pre id="console">
  	<!-- Hier landet sp√§ter der Output aus Javascript -->
	</pre>
	<script src="classes.js"></script>

	<script>
		let renderStr = "";
		let rows = 50;
		let cols = 160;
		let cnt = 0;
		let spaceshipPos = Math.round(cols / 2);
		let currentBullets = [];
		let invaders = [];
		let obstacles = [];
		let run = 0;
		let xoffset = 0;
		let yoffset = 0;
		var invaderRow = 60;
		let startPosX = 1;
		let startPosY = 1;
		const gameSpeed = 10;
		const invaderWidth = 8;
		const invaderHeight = 5;
		let rowId = 0;
		let killedInvaderCount = 0;




		/*function pauseGame() {

		if (gGamePaused === false) {
		game = clearTimeout(game);
		gGamePaused = true;
		} else if (gGamePaused === true) {
		game = setTimeout(gameLoop, 1000 / 30);
		gGamePaused = false;
		}
	}*/

		/*
		 *	SPIELELOGIK
		 */
		//Kugel abfeuern
		function newGame() {
			xoffset = 0
			yoffset = 0
			//	invaders[0] = "";
			invaders.push(generateInvader());
			//TODO Punktest√§nde

			//TODO Invaders erzeugen und in Array (invaders) schreiben damit sie gerendet werden k√∂nnen

			//Obstacles erzeugen
			obstacles.push({
				x: Math.round(cols / 2) - 5,
				y: rows - 10,
				width: 10,
				height: 3,
				char: "*"
			})
		}

		function fireBullet() {
			currentBullets.push({
				x: spaceshipPos + 3,
				y: rows - 4
			});
		}




		/*
		 *	HELFERFUNKTIONEN
		 */
		//Characters in String editieren
		function setCharsAt(str, index, chr) {
			if (index > str.length - 1) return str;
			return str.substr(0, index) + chr + str.substr(index + chr.length);
		}

		//X/Y-Wert in fortlaufende String-Position umwandeln
		function xyToStringPos(posX, posY) {
			//Zus√§tzliche Characters wegen Zeilenumbr√ºchen
			let rowOffset = posY;
			//Position im Gesamtstring, (AnzahlZeilen/YPos+i)*ZeichenProZeile plus rowOffset plus momentan gezeichnete Zeile des Ships
			let posInString = posY * cols + rowOffset + posX;
			return posInString;
		}

		//Spieler-Interaktionen verschicken
		document.addEventListener('keydown', (event) => {
			const keyCode = event.keyCode;

			if (keyCode === 37) {
				//Linke Pfeiltaste - Spaceship nach links bewegen
				spaceshipPos = Math.max(0, spaceshipPos - 1);
			} else if (keyCode === 39) {
				//Rechte Pfeiltaste - Spaceship nach rechts bewegen
				spaceshipPos = Math.min(cols - 7, spaceshipPos + 1);
			} else if (keyCode === 32) {
				//Leertase - Feuer!
				fireBullet();
			}
		}, false);


		/*
		 * RENDERFUNKTIONEN
		 */
		function renderBackground(rows, cols) {
			//console.log("render "+cnt)
			let str = ""
			for (var i = 0; i < rows; i++) {
				for (var j = 0; j < cols; j++) {
					if (i == cnt + Math.round(Math.random() * 20)) str += "`"
					else str += " "
				}
				str += "\n"
			}
			cnt++;
			if (cnt > rows) cnt = 0;
			return str;
		}

		function renderSpaceship(posX, posY) {
			//Spaceship-Array
			let spaceship = ["   ^   ",
				"#######",
				"0000000"
			]

			for (var i = 0; i < spaceship.length; i++) {
				//Zeilenweise in String schreiben
				renderStr = setCharsAt(renderStr, xyToStringPos(posX, posY + i), spaceship[i]);
			}
		}

		function renderObstacles() {
			obstacles.forEach((obstacle) => {
				for (var i = 0; i < obstacle.height; i++) {
					//Zeilenweise in String schreiben
					renderStr = setCharsAt(renderStr, xyToStringPos(obstacle.x, obstacle.y + i), obstacle.char.repeat(obstacle
						.width));
				}
			});
		}

		function renderBullets() {
			currentBullets = currentBullets.filter(bullet => bullet.y > 1);
		//Kugeln einen Schritt weiter bewegen, dann rendern
		currentBullets.forEach((bullet) => {
			bullet.y -= 1;
			if (renderStr[xyToStringPos(bullet.x, bullet.y - 1)] == '‚ñì') {
				let currentId = 0;
			//TODO: Pr√ºfen ob eine Kugel einen Invader oder ein Obstacle trifft, wenn ja Aktion ausl√∂sen
			
			for (let invaderPos = invaders[rowId].posX; invaderPos <= invaders[rowId].posX + 5*(invaderWidth*2+invaderWidth/2); invaderPos = invaderPos + invaderWidth*2+invaderWidth/2) {
					if (bullet.x > invaderPos && bullet.x < invaderPos + invaderWidth*2 + invaderWidth) {
						invaders[rowId].invaders[currentId].ischBinKaputt = true;
						invaders[rowId].invaders[currentId].explode();
						killedInvaderCount++;
						console.log("blub")
						break;
					}
					currentId++;
				}
				currentBullets = currentBullets.filter(currentBullet => currentBullet != bullet);
			}
			if (renderStr[xyToStringPos(bullet.x, bullet.y - 1)] == '=') {
				currentBullets = currentBullets.filter(currentBullet => currentBullet != bullet);
			}	
			renderStr = Helper.setCharsAt(renderStr,xyToStringPos(bullet.x, bullet.y),"üí£"); 
		})			
	}
		
	
			//Kugeln entfernen die am oberen Rand angekommen sind ohne Treffer
			//currentBullets = currentBullets.filter(bullet => bullet.y > 1);
						//Kugeln einen Schritt weiter bewegen, dann rendern
					/*	currentBullets.forEach((bullet) => {
							bullet.y -= 1;
							renderStr = setCharsAt(renderStr, xyToStringPos(bullet.x, bullet.y), "üí£");
						})*/

		
		//TODO: Pr√ºfen ob eine Kugel einen Invader oder ein Obstacle trifft, wenn ja Aktion ausl√∂sen
		
	function renderInvaderRow(invaders) {
		let currentInvXPos = invaders[rowId].posX;
		for (let j = 0; j < invaders[rowId].invaders.length; j++) {
			for (let i = 0; i < invaders[rowId].invaders[j].appearance.length; i++) {
				renderStr = Helper.setCharsAt(renderStr,xyToStringPos(invaders[rowId].invaders[j].id + currentInvXPos, invaders[rowId].posY+i), invaders[rowId].invaders[j].appearance[i]);		
			}
			currentInvXPos = currentInvXPos + invaderWidth* 2 + invaderWidth/2;
		}
	}
		

					//	renderStr = Helper.setCharsAt(renderStr, Helper.xyToStringPos(spaceshipPos + 3, rows - 2, cols), "X")
				//Kugeln entfernen die am oberen Rand angekommen sind ohne Treffer
				currentBullets = currentBullets.filter(bullet => bullet.y > 1);
				//Kugeln einen Schritt weiter bewegen, dann rendern
				currentBullets.forEach((bullet) => {
					bullet.y -= 1;
					testForInvaders(bullet);
					renderStr = setCharsAt(renderStr, xyToStringPos(bullet.x, bullet.y), "^");
				})
			
			//function renderInvaders(invader,)
			function renderInvaders(invader, xpos) {
				//TODO Invaders rendern
				let xPosition = xpos;
				let yPosition = 10;
				//random schwarz weiss Pixel generieren

				/*let h = 0//Math.floor(Math.random() * 255);
          x = Math.floor(Math.random() * 100);
         	y = Math.floor(Math.random() * 80);
          //writeCharacterToConsole('#', x, y)
          //writeCharacterToConsole('#', 2 * width - x,y)
          /*setCharsAt( 2 * width - x + xPosition, y + yPosition,chalk.hsv(h,s,v)('‚óº'));
					setCharsAt(x + xPosition, y + yPosition,chalk.hsv(h,s,v)('‚óº'))*/
				run++
				if (run >= 5) {
					run = 0;
					xoffset++;
				}
				if (xoffset >= cols - invaderRow) {
					xoffset = 0;
					yoffset++
				}
				for (let x = 1; x < 5; x++) {
					for (let y = 1; y < 10; y++) {
						if (invader[y][x] == "1") {
							renderStr = setCharsAt(renderStr, xyToStringPos(x + xPosition + xoffset, y + yPosition + yoffset), "‚ñì");
								renderStr = setCharsAt(renderStr, xyToStringPos(5 * 2 - x + xPosition + xoffset, y + yPosition + yoffset),
									"‚ñì");

							for (let i = 0; i < invaders.length; i++) {
								invader = invaders[i];
								if (invader.explodeState > 0) {
									invader.explodeState += 1;
									if (right) {
										xoffset -= 5;
									} else {
										xoffset += 5;
									}
								}
							}
						}
					}
				}
			}

			function generateInvader() {


				//generate invader
				//for(var i = 0; i < invader.length; i++){
				let invader = []

				for (let y = 1; y < 10; y++) {
					invader[y] = [];
					for (let x = 1; x < 5; x++) {
						let random = Math.random()
						if (random > 0.5) {
							invader[y][x] = 1
						} else {
							invader[y][x]
						}
						//invaders = setCharsAt(invaders,xyToStringPos(x,y),"1")

						//invaders[0] = setCharsAt(invaders[0],xyToStringPos(x,y),"1")


					}
				}
				return invader;
			}

			function testForInvaders(bullet) {
				var score = document.getElementById('score');
				var bulletX = bullet.x,
					bulletY = bullet.y;

				for (var i = 0; i < invaders.length; i++) {
					var invaderX = invaders[i].posX,
						invaderY = invaders[i].posY;

					//if (invaders[i].isVisible()) {
					// if bullet is in the invaders radius...
					if (bulletX >= (invaderX - 15) && bulletX <= (invaderX + 15) &&
						bulletY >= (invaderY - 15) && bulletY <= (invaderY + 15)) {
						invaders[i].removeVisibility();
						game.incrementScore();
						game.updateScore(score);
						return false;
					}
					//}
				}
				return true;
			}
			
			

			function fireBullet() {
				currentBullets.push({
					x: spaceshipPos + 3,
					y: rows - 4
				});
			}
			//Bullet constructor
			function bullet(x, y, w, h) {
				this.x = x;
				this.y = y;
				this.w = w;
				this.h = h;
				this.show = function () {
					ctx.fillStyle = "blue";
					ctx.fillRect(this.x, this.y, this.w, this.h);
				}

				this.move = function () {
					this.clear();
					this.y -= 5;
					this.show();
				}
				this.clear = function () {
					ctx.clearRect(this.x, this.y, this.w, this.h);
				}

				this.hits = function (bullet, enemy) {
					if (bullet.y < enemy.y + enemy.h + 10 && bullet.x < enemy.x + enemy.w && bullet.x > enemy.x - 3) {
						return (true);
					}
				}

			}


			//spaceinvader shoot
			//function renderBullets() {
				


			//spaceship hit
			//if spaceinvader.bullet = spaceship.pos 
			//spaceinvader hit






			//Hauptrenderfunktion
			function render() {
				//Render Background
				renderStr = renderBackground(rows, cols);

				//Render Obstacle
				renderObstacles();

				//Render Spaceship
				renderSpaceship(spaceshipPos, rows - 3, renderStr);

				//Render Invaders
				//renderInvaders(123456, 0, renderStr);
				for (i = 0; i < 50; i += 15) {
					renderInvaders(invaders[0], i)
				};

				//renderInvaders(invaders[0], 0, renderStr);


				//Render Bullets
				renderBullets(renderStr);

				//Gesamtergebnis anzeigen
				document.getElementById("console").innerText = renderStr;
			}

			//Es geht los - alle 40 Millisekunden rendern
			newGame();
			setInterval(render, 40);
	</script>
</body>

</html>